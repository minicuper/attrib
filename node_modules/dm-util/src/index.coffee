EventEmitter = require('events').EventEmitter
getScript = require './getScript'

# Service event emitter for client-only use
getServiceEE = ->
  return unless window?
  global._service ?= {}
  global._service.ee ?= new EventEmitter()
  global._service.ee

exports.getScript = (source, cb) ->
  return cb?() unless ee = getServiceEE()
  scripts = global._service.scripts ?=
    loaded: {}
    loading: {}

  return cb?() if scripts.loaded[source]

  if scripts.loading[source]
    return unless cb?
    ee.on 'loadScript', _listener = (loadedSource) ->
      if source is loadedSource
        ee.removeListener 'loadScript', _listener
        cb()

  else
    scripts.loading[source] = true
    getScript source, ->
      delete scripts.loading[source]
      scripts.loaded[source] = true
      ee.emit 'loadScript', source
      cb?()

exports.ajax = require('./ajax')
exports.file = require('./file')
exports.numbers = require('./numbers')
